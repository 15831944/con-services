FROM microsoft/dotnet:2.1-sdk-alpine3.7

RUN apk --no-cache add bash nodejs nodejs-npm
	

#Copy files from scm into build container and build
COPY . /build/

#Try manual restore
RUN dotnet restore /build/TRex.netstandard.sln --verbosity detailed

#publish TRex
RUN dotnet publish /build/TRex.netstandard.sln --verbosity detailed --output /trex --no-restore

#Gather dependencies - kubernetes support (and its dependencies) have to be injected here as its not part of the nuget package
RUN cp -r /root/.nuget/packages/apache.ignite/2.6.0/libs/ /trex/libs/
COPY ./build/ignite-kubernetes-2.6.0.jar /trex/libs/
# This is a vss specific build of ignite with java implementation of affinity functions
COPY ./build/ignite-corex.jar /trex/libs/
WORKDIR /trex/libs/
#RUN wget http://central.maven.org/maven2/org/apache/ignite/ignite-kubernetes/2.6.0/ignite-kubernetes-2.6.0.jar
RUN wget http://central.maven.org/maven2/org/codehaus/jackson/jackson-core-asl/1.9.13/jackson-core-asl-1.9.13.jar
RUN wget http://central.maven.org/maven2/org/codehaus/jackson/jackson-mapper-asl/1.9.13/jackson-mapper-asl-1.9.13.jar
RUN wget http://central.maven.org/maven2/log4j/log4j/1.2.17/log4j-1.2.17.jar
RUN wget http://central.maven.org/maven2/org/apache/ignite/ignite-log4j/2.6.0/ignite-log4j-2.6.0.jar


#TRex unit tests will be tested by the jenkins file as host directory mounts cannot be specified in the dockerfile
