trigger:
  branches:
    include:
      - master
      # Building of release and feature branches via Pull Requests using Azure Git is handled in Branch Policies.
  paths:
    include:
      - "src/Common/*"

pool: fsm-merino-services

variables:
  buildPlatform: "Any CPU"
  buildConfiguration: "Release"
  serviceName: Common
  rootServiceFolder: "$(System.DefaultWorkingDirectory)/src/Common"

jobs:
  - job: BuildTestCommon
    displayName: "Build & Test Common solution"
    timeoutInMinutes: 20

    steps:
      - checkout: self
        fetchDepth: 1

      - task: PowerShell@2
        displayName: "Build"
        inputs:
          filePath: build/azure-build-pipeline.ps1
          arguments: "-service $(serviceName) -action build"

      - task: PowerShell@2
        displayName: "Run unit tests"
        inputs:
          filePath: build/azure-build-pipeline.ps1
          arguments: "-service $(serviceName) -action unittest -recordTestResults false -collectCoverage false"

  - job: Build3DPService
    displayName: 'Build & Test: 3DP service'
    timeoutInMinutes: 20
    steps:
    - template: build-service.yaml
      parameters:
        servicePath: '$(System.DefaultWorkingDirectory)/src/3DP/'
        solution: '$(System.DefaultWorkingDirectory)/src/3DP/VSS.Productivity3D.Service.sln'
        testFolder: 'test'
