trigger:
  branches:
    include:
      - master
      - releases/*
      - feature/*
  paths:
    include:
      - "src/service/MockProjectWebApi/*"

pool: k8s-fsm

variables:
  buildPlatform: "Any CPU"
  buildConfiguration: "Release"
  rootServiceFolder: "$(System.DefaultWorkingDirectory)/src/service/MockProjectWebApi"

jobs:
  - job: BuildTestAndDeploy
    displayName: "Build, test and Deploy"
    timeoutInMinutes: 15

    steps:
      - checkout: self
        fetchDepth: 1

      - task: PowerShell@2
        displayName: "Build Service"
        inputs:
          filePath: build/azure-build-pipeline.ps1
          arguments: "-service Mock -action build"

      - task: PowerShell@2
        displayName: "Publish Service"
        inputs:
          filePath: build/azure-build-pipeline.ps1
          arguments: "-service Mock -action publish"

      - task: PowerShell@2
        displayName: "Push Docker Image"
        inputs:
          filePath: build/azure-build-pipeline.ps1
          arguments: "-service Mock -action pushImage -branch $(Build.SourceBranchName) -buildId $(Build.BuildId)"

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: Charts'
        inputs:
          PathtoPublish: $(rootServiceFolder)/deploy
          ArtifactName: Charts
        condition: succeededOrFailed()

      # - task: PublishBuildArtifacts@1
      #   displayName: 'Publish Artifact: All Artfiacts'
      #   inputs:
      #     PathtoPublish: artifacts
      #     ArtifactName: Artifacts
      #   condition: succeededOrFailed()
